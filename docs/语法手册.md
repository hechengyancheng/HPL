# H 语言语法规范 v1.0

**H** 是一门为文字冒险游戏设计的领域特定语言（DSL），采用自然语言风格的语法，使开发者能够以叙述故事的方式编写游戏逻辑。

---

## 目录

1. [词法结构](#一词法结构)
2. [数据类型](#二数据类型)
3. [表达式](#三表达式)
4. [语句](#四语句)
5. [世界定义](#五世界定义)
6. [事件系统](#六事件系统)
7. [对话系统](#七对话系统)
8. [游戏生命周期](#八游戏生命周期)
9. [测试框架](#九测试框架)
10. [形式化语法](#十形式化语法)

---

## 一、词法结构

### 1.1 字符集

H 语言使用 UTF-8 编码，标识符支持 Unicode 字符。

### 1.2 注释

| 类型 | 语法 | 说明 |
|------|------|------|
| 单行注释 | `// 内容` | 从 `//` 到行尾 |
| 多行注释 | `/* 内容 */` | 可跨越多行，不支持嵌套 |

### 1.3 缩进

缩进具有语法意义，用于表示代码块的层级结构：

- 使用 **4 个空格** 表示一级缩进
- 禁止使用 Tab 字符
- 同一层级的语句必须严格对齐

```h
if health is less than 50:
    say "You are wounded."
    set player.status to "injured"
```

### 1.4 标识符

**命名规则：**
- 以字母或下划线开头
- 可包含字母、数字、下划线
- 区分大小写

**命名约定：**

| 类型 | 约定 | 示例 |
|------|------|------|
| 变量 | 小写开头，驼峰式 | `playerHealth`, `itemCount` |
| 常量 | 全大写，下划线分隔 | `MAX_INVENTORY` |
| 全局变量 | `$` 前缀 | `$score`, `$gameTime` |
| 类型标识符 | 大写开头 | `Room`, `Item`, `Character` |

**保留关键字：**

```
and, assert, by, contains, description, dialog, else, end, event
every, exits, false, for, from, game, goto, has, if, in, increase
is, item, items, not, null, on, option, or, perform, player, remove
room, run, say, set, speaker, start, state, stop, tags, test, text
this, timer, to, true, turn, uses, wait, when, while
```

---

## 二、数据类型

### 2.1 基本类型

| 类型 | 描述 | 示例 |
|------|------|------|
| `number` | 64位浮点数 | `42`, `3.14`, `-7` |
| `string` | 双引号包裹的文本 | `"hello"`, `"line1\nline2"` |
| `boolean` | 布尔值 | `true`, `false` |
| `list` | 有序集合 | `[item1, item2]` |
| `null` | 空值 | `null` |

### 2.2 字符串

字符串使用双引号 `"` 包裹，支持以下转义序列：

| 序列 | 含义 |
|------|------|
| `\"` | 双引号 |
| `\\` | 反斜杠 |
| `\n` | 换行符 |
| `\t` | 制表符 |

### 2.3 列表

列表使用方括号 `[]` 包裹，元素用逗号分隔：

```h
set inventory to [sword, shield, potion]
set directions to [north, south, east, west]
```

列表支持的操作：
- `contains`：检查包含关系
- `is in`：检查元素是否在列表中

---

## 三、表达式

### 3.1 运算符优先级

从高到低排列：

| 优先级 | 运算符 | 结合性 |
|--------|--------|--------|
| 1 | `.`（属性访问） | 左结合 |
| 2 | `not` | 右结合 |
| 3 | `*`, `/`, `%` | 左结合 |
| 4 | `+`, `-` | 左结合 |
| 5 | `is`, `is not`, `is greater than`, `is less than`, `is at least`, `is at most`, `==`, `!=`, `<`, `>`, `<=`, `>=` | 左结合 |
| 6 | `has`, `is in` | 左结合 |
| 7 | `and` | 左结合 |
| 8 | `or` | 左结合 |

### 3.2 算术运算

```h
set total to price * quantity + tax
set damage to baseDamage * critMultiplier - armor
```

### 3.3 比较运算

支持自然语言风格和符号别名两种形式，完全等价：

| 自然语言 | 符号 | 含义 |
|----------|------|------|
| `is` | `==` | 等于 |
| `is not` | `!=` | 不等于 |
| `is greater than` | `>` | 大于 |
| `is less than` | `<` | 小于 |
| `is at least` | `>=` | 大于等于 |
| `is at most` | `<=` | 小于等于 |

```h
if player.level is greater than 10:
if player.level > 10:
```

### 3.4 逻辑运算

```h
if player.hasKey and door.isLocked:
if not enemy.isAlive or player.isInvisible:
```

### 3.5 成员检查

| 运算符 | 含义 | 示例 |
|--------|------|------|
| `has` | 检查拥有关系（库存、属性） | `player has sword` |
| `is in` | 检查位置关系 | `sword is in player.inventory` |

### 3.6 属性访问

使用 `.` 访问对象属性：

```h
player.health
chest.isLocked
room.exits.north
```

---

## 四、语句

### 4.1 赋值语句

```h
set <变量> to <表达式>
```

变量类型：
- 局部变量：直接命名
- 全局变量：`$` 前缀
- 对象属性：使用 `.` 访问

```h
set health to 100
set $score to 0
set player.health to 100
set chest.items to [gold, gem]
```

### 4.2 条件语句

```h
if <条件>:
    <语句块>
else if <条件>:
    <语句块>
else:
    <语句块>
```

示例：

```h
if player.health is less than 25:
    say "Critical health!"
    set player.status to "critical"
else if player.health is less than 50:
    say "You are wounded."
else:
    say "You are healthy."
```

### 4.3 循环语句

```h
while <条件>:
    <语句块>
```

示例：

```h
while enemy.health is greater than 0:
    perform combat.attack with player, enemy
    say "You attack the enemy!"
```

### 4.4 动作指令

| 指令 | 语法 | 说明 |
|------|------|------|
| 输出 | `say <字符串>` | 向玩家显示文本 |
| 添加 | `add <物品> to <目标>` | 将物品添加到目标 |
| 移除 | `remove <物品> from <来源>` | 从来源移除物品 |
| 移动 | `move to <房间>` | 移动玩家到指定房间 |
| 等待 | `wait for <时间>` | 暂停指定时间 |
| 增加 | `increase <变量> by <数值>` | 增加变量值 |
| 减少 | `decrease <变量> by <数值>` | 减少变量值 |
| 执行 | `perform <动作> with <参数>, ...` | 执行复杂动作 |
| 结束 | `end game` | 结束游戏 |

### 4.5 计时器

```h
start timer <标识符> for <数值> <单位>
stop timer <标识符>
```

时间单位：`seconds`, `minutes`

### 4.6 并行执行

```h
run in parallel:
    <语句块>
```

---

## 五、世界定义

### 5.1 房间（Room）

```h
Room <标识符>:
    description is <字符串>
    items is [<物品列表>]
    characters is [<角色列表>]
    exits is [<出口列表>]
```

**出口定义：**

```h
<方向> to <目标房间>
<方向> to <目标房间> if <条件>
```

完整示例：

```h
Room Kitchen:
    description is "A cozy kitchen with a fireplace."
    items is [knife, apple, pot]
    characters is [cook]
    exits is [
        north to Garden,
        down to Cellar if trapdoor.isOpen,
        east to DiningRoom
    ]
```

### 5.2 物品（Item）

```h
Item <标识符>:
    description is <字符串>
    tags is [<标签列表>]
    <属性> is <值>
    
    on <动词>:
        <语句块>
```

**特殊关键字 `this`：**

在 Item 定义内部，`this` 指代当前物品实例。

示例：

```h
Item magic_chest:
    description is "An ornate chest with mystical runes."
    tags is [container, magic]
    isLocked is true
    contents is [magic_ring]
    
    on opens:
        if this.isLocked:
            say "The chest is magically sealed."
        else:
            say "The chest opens with a soft glow."
            set this.isOpen to true
    
    on uses magic_key:
        if player has magic_key:
            set this.isLocked to false
            say "The key fits perfectly. The seal breaks!"
        else:
            say "You need a magic key to open this."
```

### 5.3 角色（Character）

```h
Character <标识符>:
    description is <字符串>
    <属性> is <值>
    uses dialog <对话树标识符>
```

示例：

```h
Character old_merchant:
    description is "A weary merchant with a loaded cart."
    mood is "friendly"
    uses dialog merchant_dialog
```

---

## 六、事件系统

### 6.1 事件监听

所有事件使用统一的 `on` 关键字声明：

```h
on <事件类型>: <触发条件>:
    <语句块>
```

### 6.2 事件类型

| 类型 | 语法 | 触发时机 |
|------|------|----------|
| 玩家动作 | `on action: player <动词> [this]` | 玩家对物品执行动作 |
| 玩家交互 | `on action: player <动词> <物品> on <目标>` | 玩家使用物品作用于目标 |
| 状态变化 | `on state: <条件>` | 条件变为真时 |
| 计时器 | `on timer: <标识符> expires` | 计时器到期时 |
| 随机事件 | `on event: <标识符>` | 按概率触发 |

### 6.3 示例

```h
on action: player uses rusty_key on chest:
    if chest.isLocked:
        set chest.isLocked to false
        set rusty_key.isBroken to true
        increase $score by 10
        say "The key turns with a snap... and breaks!"
    else:
        say "The chest is already unlocked."

on state: hour is 18:
    set weather to "night"
    say "The sun sets. Darkness falls."

on timer: bomb expires:
    say "BOOM!"
    end game

on event: random_encounter:
    30% chance:
        say "A wild wolf appears!"
        start combat with wolf
    70% chance:
        say "The path remains clear."
```

---

## 七、对话系统

### 7.1 对话树定义

```h
dialog <标识符>:
    state <标识符>:
        speaker is <角色标识符>
        text is <字符串>
        
        option <文本>:
            [requires: <条件>]
            [action:
                <语句块>]
            goto <下一状态>
```

### 7.2 选项控制

- `requires`：前置条件，不满足时选项不显示
- `action`：选择后执行的动作
- `goto`：跳转到的状态

### 7.3 示例

```h
dialog merchant_dialog:
    state greeting:
        speaker is old_merchant
        text is "Greetings, traveler! Care to see my wares?"
        
        option "Show me what you have":
            requires: player.gold is greater than 0
            goto show_goods
        
        option "I'm just looking":
            goto browsing
        
        option "Goodbye":
            goto farewell
    
    state show_goods:
        speaker is old_merchant
        text is "Finest quality! Sword for 50 gold, shield for 40."
        
        option "Buy sword":
            requires: player.gold is greater than 50
            action:
                decrease player.gold by 50
                add sword to player.inventory
            goto greeting
        
        option "Buy shield":
            requires: player.gold is greater than 40
            action:
                decrease player.gold by 40
                add shield to player.inventory
            goto greeting
        
        option "Maybe later":
            goto greeting
    
    state browsing:
        speaker is old_merchant
        text is "Take your time. Let me know if you need anything."
        
        option "Actually, show me your wares":
            goto show_goods
        
        option "Goodbye":
            goto farewell
    
    state farewell:
        speaker is old_merchant
        text is "Safe travels, friend!"
```

---

## 八、游戏生命周期

### 8.1 游戏启动

```h
on game start:
    <初始化语句>
```

示例：

```h
on game start:
    set $score to 0
    set $turns to 0
    set player.health to 100
    set player.inventory to []
    set player.location to "StartRoom"
    set world.time to "morning"
```

### 8.2 每回合更新

```h
on every turn:
    <更新语句>
```

示例：

```h
on every turn:
    increase $turns by 1
    increase world.hour by 1
    
    if world.hour is greater than 22 and not player.has lantern:
        say "You are engulfed by darkness..."
        end game
```

---

## 九、测试框架

### 9.1 测试定义

```h
test <名称>:
    <语句块>
    <断言>
```

### 9.2 断言

```h
assert <条件>
assert <表达式> is <值>
assert <列表> contains <元素>
assert not <条件>
```

### 9.3 示例

```h
test "chest unlocking":
    // Setup
    set player.inventory to [rusty_key]
    set chest.isLocked to true
    
    // Action
    perform player.uses with rusty_key, chest
    
    // Assertions
    assert chest.isLocked is false
    assert rusty_key.isBroken is true
    assert player.inventory contains rusty_key
```

---

## 十、形式化语法

### 10.1 EBNF 定义

```ebnf
(* ============================================
   H 语言形式化语法定义 v1.0
   ============================================ *)

program         = { definition | statement | event_handler };

(* --------------------------------------------
   定义
   -------------------------------------------- *)
definition      = room_def | item_def | character_def | dialog_def | test_def;

room_def        = "Room", identifier, ":", indent, room_body, dedent;
room_body       = desc_attr, [ items_attr ], [ chars_attr ], [ exits_attr ];
desc_attr       = "description", "is", string;
items_attr      = "items", "is", list;
chars_attr      = "characters", "is", list;
exits_attr      = "exits", "is", "[", [ exit_def, { ",", exit_def } ], "]";
exit_def        = identifier, "to", identifier, [ "if", expression ];

item_def        = "Item", identifier, ":", indent, item_body, dedent;
item_body       = desc_attr, [ tags_attr ], { property }, { verb_handler };
tags_attr       = "tags", "is", list;
property        = identifier, "is", value;
verb_handler    = "on", identifier, ":", indent, { statement }, dedent;

character_def   = "Character", identifier, ":", indent, char_body, dedent;
char_body       = desc_attr, { property }, [ "uses", "dialog", identifier ];

dialog_def      = "dialog", identifier, ":", indent, { state_def }, dedent;
state_def       = "state", identifier, ":", indent, speaker_attr, text_attr, { option_def }, dedent;
speaker_attr    = "speaker", "is", identifier;
text_attr       = "text", "is", string;
option_def      = "option", string, ":", indent, option_body, dedent;
option_body     = [ "requires", ":", expression ], [ "action", ":", indent, { statement }, dedent ], "goto", identifier;

test_def        = "test", string, ":", indent, { statement }, { assert_stmt }, dedent;

(* --------------------------------------------
   语句
   -------------------------------------------- *)
statement       = assignment | if_stmt | while_stmt | say_stmt
                 | add_stmt | remove_stmt | move_stmt | endgame_stmt
                 | timer_stmt | stop_timer_stmt | increase_stmt | decrease_stmt
                 | perform_stmt | parallel_stmt;

assignment      = "set", lvalue, "to", expression;
lvalue          = identifier | global_var | property_access;
global_var      = "$", identifier;
property_access = identifier, ".", identifier;

if_stmt         = "if", expression, ":", indent, { statement }, [ elif_block ], [ else_block ], dedent;
elif_block      = "else", "if", expression, ":", indent, { statement }, dedent;
else_block      = "else", ":", indent, { statement }, dedent;

while_stmt      = "while", expression, ":", indent, { statement }, dedent;

say_stmt        = "say", string;

add_stmt        = "add", identifier, "to", expression;
remove_stmt     = "remove", identifier, "from", expression;
move_stmt       = "move", "to", identifier;
endgame_stmt    = "end", "game";

increase_stmt   = "increase", lvalue, "by", expression;
decrease_stmt   = "decrease", lvalue, "by", expression;

perform_stmt    = "perform", identifier, [ "with", expression, { ",", expression } ];

timer_stmt      = "start", "timer", identifier, "for", number, time_unit;
time_unit       = "seconds" | "minutes";
stop_timer_stmt = "stop", "timer", identifier;

parallel_stmt   = "run", "in", "parallel", ":", indent, { statement }, dedent;

(* --------------------------------------------
   事件处理
   -------------------------------------------- *)
event_handler   = "on", event_type, ":", event_target, ":", indent, { statement }, dedent;
event_type      = "action" | "state" | "timer" | "event" | "game start" | "every turn";
event_target    = player_action | expression | identifier, "expires";

player_action   = "player", identifier, [ "this" ]
                 | "player", identifier, identifier, "on", identifier;

(* --------------------------------------------
   断言
   -------------------------------------------- *)
assert_stmt     = "assert", [ "not" ], assert_expr;
assert_expr     = expression | expression, "is", value | expression, "contains", expression;

(* --------------------------------------------
   表达式
   -------------------------------------------- *)
expression      = or_expr;

or_expr         = and_expr, { "or", and_expr };
and_expr        = not_expr, { "and", not_expr };
not_expr        = [ "not" ], comparison;

comparison      = additive, [ compare_op, additive ];
compare_op      = "is" | "is not" | "is greater than" | "is less than" 
                 | "is at least" | "is at most"
                 | "==" | "!=" | "<" | ">" | "<=" | ">=";

additive        = multiplicative, { ( "+" | "-" ), multiplicative };
multiplicative  = unary, { ( "*" | "/" | "%" ), unary };

unary           = member_check | primary;
member_check    = identifier, "has", identifier
                 | identifier, "is", "in", expression;

primary         = literal | lvalue | "(", expression, ")";
literal         = number | string | boolean | null | list;

(* --------------------------------------------
   词法单元
   -------------------------------------------- *)
identifier      = letter, { letter | digit | "_" };
string          = "\"", { char | escape }, "\"";
number          = [ "-" ], digit, { digit }, [ ".", digit, { digit } ];
boolean         = "true" | "false";
null            = "null";
list            = "[", [ value, { ",", value } ], "]";
value           = expression;

letter          = "a" .. "z" | "A" .. "Z" | unicode_letter;
digit           = "0" .. "9";
escape          = "\\", ( "\"" | "\\" | "n" | "t" );

indent          = "    ";  (* 4 spaces *)
dedent          = "";      (* 缩进结束，由词法分析器处理 *)

(* --------------------------------------------
   注释
   -------------------------------------------- *)
comment         = line_comment | block_comment;
line_comment    = "//", { any_char }, "\n";
block_comment   = "/*", { any_char | "*" }, "*/";
```

### 10.2 运算符优先级表

| 优先级 | 运算符 | 说明 |
|--------|--------|------|
| 1 | `.` | 属性访问 |
| 2 | `not` | 逻辑非 |
| 3 | `*`, `/`, `%` | 乘、除、取模 |
| 4 | `+`, `-` | 加、减 |
| 5 | `is`, `is not`, `is greater than`, `is less than`, `is at least`, `is at most`, `==`, `!=`, `<`, `>`, `<=`, `>=` | 比较运算 |
| 6 | `has`, `is in` | 成员检查 |
| 7 | `and` | 逻辑与 |
| 8 | `or` | 逻辑或 |

---

## 附录：完整示例

```h
// 古堡探险 - 完整游戏示例

on game start:
    set $score to 0
    set $moves to 0
    set player.health to 100
    set player.inventory to []
    set player.location to "Entrance"

Room Entrance:
    description is "You stand before a towering iron gate. The castle looms above."
    items is [rusty_key]
    exits is [north to Courtyard]

Room Courtyard:
    description is "A cobblestone courtyard. Vines climb the weathered walls."
    items is [lantern]
    characters is [guard]
    exits is [
        south to Entrance,
        east to GreatHall if great_door.isOpen
    ]

Item rusty_key:
    description is "An old iron key, covered in rust."
    
    on uses this on great_door:
        if great_door.isLocked:
            set great_door.isLocked to false
            set great_door.isOpen to true
            set this.isBroken to true
            say "The key turns with a grinding sound... and snaps!"
            say "But the door swings open."
        else:
            say "The door is already unlocked."

Item lantern:
    description is "A brass lantern. It needs oil."
    hasOil is false
    
    on uses oil_flask:
        set this.hasOil to true
        set this.isLit to true
        say "You fill and light the lantern. Warm glow fills the area."

Character guard:
    description is "A tired guard leaning on his spear."
    uses dialog guard_dialog

dialog guard_dialog:
    state initial:
        speaker is guard
        text is "Halt! The east wing is locked. No one enters."
        
        option "I have business inside":
            goto business
        
        option "Where is the key?":
            goto key_inquiry
        
        option "Goodbye":
            goto farewell
    
    state business:
        speaker is guard
        text is "What business could you have in there?"
        
        option "I'm the new librarian":
            requires: player has appointment_letter
            action:
                increase $score by 5
            goto impressed
        
        option "None of your concern":
            goto annoyed
    
    state key_inquiry:
        speaker is guard
        text is "The master has the only key. He never leaves the tower."
        
        option "Thanks for the information":
            goto initial
    
    state impressed:
        speaker is guard
        text is "Ah, forgive me sir! Please enter."
        action:
            set guard.letsPass to true
        goto farewell
    
    state annoyed:
        speaker is guard
        text is "Watch your tongue, stranger!"
        goto initial
    
    state farewell:
        speaker is guard
        text is "Move along now."

on action: player attacks guard:
    say "The guard raises his spear. 'You dare?'"
    set guard.isHostile to true

on state: player.location is "Courtyard" and not player has lantern:
    say "It's getting dark. You should find a light source."

on every turn:
    increase $moves by 1
    if $moves is greater than 100:
        say "You collapse from exhaustion..."
        end game

test "door unlocking":
    set great_door.isLocked to true
    set player.inventory to [rusty_key]
    perform player.uses with rusty_key, great_door
    assert great_door.isOpen is true
    assert rusty_key.isBroken is true
```

---

**文档版本：** v1.0  
**最后更新：** 2026年
